#ifndef __YOG_YOG_H__
#define __YOG_YOG_H__

#include <stdlib.h>

#define BOOL    int
#define FALSE   (0)
#define TRUE    (!FALSE)

struct Heap {
    size_t size;
    unsigned char* base;
    unsigned char* free;
    struct Heap* next;
};

typedef struct Heap Heap;

struct YogVm {
    BOOL need_gc;
    Heap* heap;
};

typedef struct YogVm YogVm;

struct YogEnv {
    YogVm* vm;
};

#define ENV_VM(env) ((env)->vm)

typedef struct YogEnv YogEnv;

enum YogValType {
    VAL_INT, 
    VAL_FLOAT, 
    VAL_OBJ, 
    VAL_TRUE, 
    VAL_FALSE, 
    VAL_NIL, 
    VAL_SYMBOL, 
};

typedef enum YogValType YogValType;

enum YogObjType {
    OBJ_BUFFER, 
    OBJ_TABLE, 
    OBJ_TABLE_ENTRY, 
    OBJ_TABLE_ENTRY_ARRAY, 
};

typedef enum YogObjType YogObjType;

struct YogObj {
    YogObjType type;
    void* forwarding_addr;
    size_t size;
};

#define YOGOBJ_HEAD YogObj obj_head
#define YOGOBJ(x)   ((YogObj*)(x))

typedef struct YogObj YogObj;

struct YogVal {
    YogValType type;
    union {
        int n;
        double f;
        unsigned int symbol;
        YogObj* obj;
    } u;
};

#define YOGVAL_TYPE(v)      ((v).type)
#define YOGVAL_NUM(v)       ((v).u.n)
#define YOGVAL_FLOAT(v)     ((v).u.f)
#define YOGVAL_SYMBOL(v)    ((v).u.symbol)
#define YOGVAL_OBJ(v)       ((v).u.obj)

typedef struct YogVal YogVal;

struct YogHashType {
    int (*compare)(YogEnv*, YogVal, YogVal);
    int (*hash)(YogEnv*, YogVal);
};

typedef struct YogHashType YogHashType;

struct YogTableEntry {
    YOGOBJ_HEAD;
    unsigned int hash;
    YogVal key;
    YogVal record;
    struct YogTableEntry* next;
};

typedef struct YogTableEntry YogTableEntry;

struct YogTableEntryArray {
    YOGOBJ_HEAD;
    unsigned int size;
    YogTableEntry* items[0];
};

typedef struct YogTableEntryArray YogTableEntryArray;

struct YogTable {
    YOGOBJ_HEAD;
    YogHashType* type;
    int num_bins;
    int num_entries;
    YogTableEntryArray* bins;
};

typedef struct YogTable YogTable;

/* $PROTOTYPE_START$ */

/**
 * DON'T EDIT THIS AREA. HERE IS GENERATED BY update_prototype.py.
 */

/* src/value.c */
BOOL YogVal_equals_exact(YogEnv*, YogVal, YogVal);
YogVal YogVal_nil();
YogVal YogVal_obj(YogObj*);

/* src/st.c */
BOOL YogTable_lookup(YogEnv*, YogTable*, YogVal, YogVal*);
BOOL YogTable_insert(YogEnv*, YogTable*, YogVal, YogVal);
void YogTable_add_direct(YogEnv*, YogTable*, YogVal, YogVal);
YogTable* YogTable_copy(YogEnv*, YogTable*);
BOOL YogTable_delete(YogEnv*, YogTable*, YogVal*, YogVal*);
BOOL YogTable_delete_safe(YogEnv*, YogTable*, YogVal*, YogVal*, YogVal);
BOOL YogTable_foreach(YogEnv*, YogTable*, int (*)(YogEnv*, YogVal, YogVal, YogVal), YogVal);
void YogTable_cleanup_safe(YogEnv*, YogTable*, YogVal);
YogTable* YogTable_new_symbol_table(YogEnv*);

/* src/vm.c */
YogObj* YogVm_alloc_obj(YogEnv*, YogVm*, YogObjType, size_t);
YogVm* YogVm_new(size_t);

/* src/main.c */

/* src/error.c */
void Yog_assert(YogEnv*, BOOL, const char*);

/* $PROTOTYPE_END$ */

#define ALLOC_OBJ(env, obj_type, type)  (type*)YogVm_alloc_obj(env, ENV_VM(env), obj_type, sizeof(type))
#define ALLOC_OBJ_SIZE(env, obj_type, type, size)   (type*)YogVm_alloc_obj(env, ENV_VM(env), obj_type, size)

#endif
/**
 * vim: tabstop=4 shiftwidth=4 expandtab softtabstop=4
 */
