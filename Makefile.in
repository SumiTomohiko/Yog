
DIRS = @DIRS@
PTHREADS_W32_DIR = @PTHREADS_W32_DIR@
prefix = @prefix@
VERSION = @PACKAGE_VERSION@
ARCHIVE = Yog-$(VERSION)
PYTHON = python2.6
SYNTAX_DIR = $(prefix)/share/vim/vim71/syntax

CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
			 configure.lineno config.status.lineno

.PHONY: all clean distclean maintainer-clean doc proto test test-bdw test-copying test-mark-sweep test-mark-sweep-compact test-generational update-version install-vim install dist distcheck

all:
	@for subdir in $(PTHREADS_W32_DIR); do \
		(cd $${subdir} && $(MAKE) GC-static); \
	done
	@for subdir in $(DIRS); do \
		(cd $${subdir} && $(MAKE)); \
	done
	cp -f src/yog-copying src/yog

clean:
	@for subdir in $(PTHREADS_W32_DIR); do \
		(cd $${subdir} && $(MAKE) clean); \
	done
	@for subdir in $(DIRS) tests doc; do \
		(cd $${subdir} && $(MAKE) clean); \
	done
	find tests -name "*.pyc" -print0 | xargs --null rm -f
	rm -f core*

distclean:
	@for subdir in $(PTHREADS_W32_DIR); do \
		(cd $${subdir} && $(MAKE) clean); \
	done
	@for subdir in $(DIRS) tests doc; do \
		(cd $${subdir} && $(MAKE) distclean); \
	done
	find tests -name "*.pyc" -print0 | xargs --null rm -f
	rm -f core*
	rm -f $(CONFIG_DISTCLEAN_FILES)
	rm -f Makefile

maintainer-clean:
	@for subdir in $(PTHREADS_W32_DIR); do \
		(cd $${subdir} && $(MAKE) clean); \
	done
	@for subdir in $(DIRS) tests doc; do \
		(cd $${subdir}; $(MAKE) maintainer-clean); \
	done
	find tests -name "*.pyc" -print0 | xargs --null rm -f
	rm -f core*
	rm -f $(CONFIG_DISTCLEAN_FILES)
	rm -rf autom4te.cache
	rm -f Makefile

doc:
	(cd doc && make)

proto:
	$(PYTHON) tools/update_prototype.py

test test-installed test-copying test-mark-sweep test-mark-sweep-compact test-bdw test-generational:
	cd tests && $(MAKE) $@

am--refresh:
	@:

update-version:
	cd src && $(MAKE) $@

install-vim:
	mkdir -p $(SYNTAX_DIR)
	cp yog.vim $(SYNTAX_DIR)
	@grep "NOTICE" yog.vim | sed -e 's/" NOTICE: //'

install:
	install src/yog $(prefix)/bin
	cd ext && $(MAKE) $@

dist:
	rm -rf $(ARCHIVE)
	git archive --prefix=$(ARCHIVE)/ HEAD | tar xf -
	cp -r doc/html $(ARCHIVE)/doc
	tar czf $(ARCHIVE).tar.gz $(ARCHIVE)
	tar cjf $(ARCHIVE).tar.bz2 $(ARCHIVE)
	tar c $(ARCHIVE) | xz --compress > $(ARCHIVE).tar.xz
	rm -f $(ARCHIVE).zip
	zip -r $(ARCHIVE).zip $(ARCHIVE)
	rm -rf $(ARCHIVE)

distcheck:
	rm -rf $(ARCHIVE)
	tar xf $(ARCHIVE).tar.gz
	(cd $(ARCHIVE) && ./configure && make)
	rm -rf $(ARCHIVE)
	tar xf $(ARCHIVE).tar.bz2
	(cd $(ARCHIVE) && ./configure && make)
	rm -rf $(ARCHIVE)
	xzcat $(ARCHIVE).tar.xz | tar x
	(cd $(ARCHIVE) && ./configure && make)
	rm -rf $(ARCHIVE)
	unzip $(ARCHIVE).zip
	(cd $(ARCHIVE) && ./configure && make)
	rm -rf $(ARCHIVE)

# vim: tabstop=8 shiftwidth=8 noexpandtab filetype=automake
